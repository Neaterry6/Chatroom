<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamMe Chatroom</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>StreamMe Chatroom</header>
    <div class="chat-room">
        <div class="chat-box" id="chatBox"></div>
        <div class="input-container">
            <button id="recordButton">🎤</button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <button id="uploadImageButton">📷</button>
            <input type="text" id="chatInput" placeholder="Type your message...">
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const recordButton = document.getElementById('recordButton');
        const uploadImageButton = document.getElementById('uploadImageButton');
        const imageInput = document.getElementById('imageInput');

        let mediaRecorder;
        let audioChunks = [];
        let replyToMessageId = null;

        // Function to sanitize text to prevent code injection
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send a message to the server
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            const timestamp = new Date().toLocaleTimeString();
            const data = {
                message: sanitizeText(message),
                timestamp,
                replyTo: replyToMessageId,
            };

            socket.emit('chatMessage', data);
            chatInput.value = '';
            replyToMessageId = null; // Reset reply
        }

        // Display messages received from the server
        socket.on('chatMessage', ({ id, username, message, timestamp, replyTo }) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.setAttribute('data-id', id);

            msgDiv.innerHTML = `
                <span class="username">${sanitizeText(username)}</span>
                <span class="timestamp">${sanitizeText(timestamp)}</span>
                <div class="text">${replyTo ? `<blockquote>Replying to: ${sanitizeText(replyTo)}</blockquote>` : ''}${sanitizeText(message)}</div>
                <div class="message-options">
                    <button class="react">😊</button>
                    <button class="reply">Reply</button>
                </div>
            `;

            msgDiv.querySelector('.react').addEventListener('click', () => reactToMessage(id));
            msgDiv.querySelector('.reply').addEventListener('click', () => replyToMessage(id));

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // React to a message
        function reactToMessage(messageId) {
            const reaction = prompt('React with an emoji: 😊❤️🔥👍');
            if (reaction) {
                socket.emit('reactToMessage', { messageId, reaction: sanitizeText(reaction) });
            }
        }

        // Reply to a message
        function replyToMessage(messageId) {
            replyToMessageId = messageId;
            chatInput.focus();
        }

        // Handle reactions
        socket.on('reaction', ({ messageId, reaction }) => {
            const messageDiv = document.querySelector(`[data-id="${messageId}"]`);
            if (messageDiv) {
                const reactionDiv = messageDiv.querySelector('.reactions') || document.createElement('div');
                reactionDiv.classList.add('reactions');
                reactionDiv.textContent += ` ${sanitizeText(reaction)}`;
                messageDiv.appendChild(reactionDiv);
            }
        });

        // Record and send voice notes
        recordButton.addEventListener('mousedown', startRecording);
        recordButton.addEventListener('mouseup', stopRecording);

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                })
                .catch(err => console.error('Error accessing microphone:', err));
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        socket.emit('voiceNote', { audio: base64Audio, timestamp: new Date().toLocaleTimeString() });
                    };
                    reader.readAsDataURL(audioBlob);
                    audioChunks = [];
                };
            }
        }

        // Display voice notes
        socket.on('voiceNote', ({ username, audio, timestamp }) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.innerHTML = `
                <span class="username">${sanitizeText(username)}</span>
                <span class="timestamp">${sanitizeText(timestamp)}</span>
                <audio controls src="data:audio/webm;base64,${sanitizeText(audio)}"></audio>
            `;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // Upload and send an image
        uploadImageButton.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Image = reader.result.split(',')[1];
                    socket.emit('image', { image: base64Image, timestamp: new Date().toLocaleTimeString() });
                };
                reader.readAsDataURL(file);
                imageInput.value = ''; // Reset the input
            }
        });

        // Display images
        socket.on('image', ({ username, image, timestamp }) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.innerHTML = `
                <span class="username">${sanitizeText(username)}</span>
                <span class="timestamp">${sanitizeText(timestamp)}</span>
                <img src="data:image/png;base64,${sanitizeText(image)}" alt="Image" style="max-width: 200px; max-height: 200px;">
            `;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    </script>
</body>
</html>
